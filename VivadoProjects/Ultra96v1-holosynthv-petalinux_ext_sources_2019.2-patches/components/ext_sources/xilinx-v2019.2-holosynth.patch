From 5e3a31c9640619d073a3ea2d6fd8e20800d2a31d Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Sat, 28 Mar 2020 18:01:27 +0100
Subject: [PATCH 1/3] spl boot test

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 configs/avnet_ultra96_rev1_defconfig | 4 ++++
 tools/zynqmp_pm_cfg_obj_convert.py   | 3 +--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/configs/avnet_ultra96_rev1_defconfig b/configs/avnet_ultra96_rev1_defconfig
index f6d583083b..141391dbeb 100644
--- a/configs/avnet_ultra96_rev1_defconfig
+++ b/configs/avnet_ultra96_rev1_defconfig
@@ -86,6 +86,10 @@ CONFIG_USB_ETHER=y
 CONFIG_USB_ETH_CDC=y
 CONFIG_USB_HOST_ETHER=y
 CONFIG_USB_ETHER_ASIX=y
+CONFIG_USB_ETHER_ASIX88179=y
 CONFIG_SPL_GZIP=y
 CONFIG_OF_LIBFDT_OVERLAY=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_ZYNQMP_SPL_PM_CFG_OBJ_FILE=/home/mib/Projects/u-boot_build_files/pm_cfg_obj
+CONFIG_CMD_SAVEENV=y
+CONFIG_ENV_IS_IN_FAT=y
diff --git a/tools/zynqmp_pm_cfg_obj_convert.py b/tools/zynqmp_pm_cfg_obj_convert.py
index dd27f47921..7bb660f9bc 100755
--- a/tools/zynqmp_pm_cfg_obj_convert.py
+++ b/tools/zynqmp_pm_cfg_obj_convert.py
@@ -289,8 +289,7 @@ code = in_file.read()
 code = re.sub('//.*?\n|/\*.*?\*/', '', code, flags=re.DOTALL)
 
 # remove everything outside the XPm_ConfigObject array definition
-code = re.search('const u32 XPm_ConfigObject.*= {\n(.*)};',
-                 code, flags=re.DOTALL).group(1)
+code = re.search('const u32 XPm_ConfigObject.*= {\n(.*)};', code, flags=re.DOTALL).group(1)
 
 # Process each comma-separated array item
 for item in code.split(','):
-- 
2.25.1


From cf63014ed54e7a2aa0cd000d8c59a2e120eeede4 Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Sat, 28 Mar 2020 19:32:38 +0100
Subject: [PATCH 2/3] config files needed for petalinux-build

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 include/configs/platform-auto.h | 176 ++++++++++++++++++++++++++++++++
 include/configs/platform-top.h  |  38 +++++++
 2 files changed, 214 insertions(+)
 create mode 100755 include/configs/platform-auto.h
 create mode 100755 include/configs/platform-top.h

diff --git a/include/configs/platform-auto.h b/include/configs/platform-auto.h
new file mode 100755
index 0000000000..7b1c74e109
--- /dev/null
+++ b/include/configs/platform-auto.h
@@ -0,0 +1,176 @@
+/*
+ * This file is auto-generated by PetaLinux SDK 
+ * DO NOT MODIFY this file, the modification will not persist
+ */
+
+#ifndef __PLNX_CONFIG_H
+#define __PLNX_CONFIG_H
+
+/* The following table includes the supported baudrates */
+
+
+#define CONFIG_SYS_BAUDRATE_TABLE  { 4800, 9600, 19200, 38400, 57600, 115200 }
+
+
+
+/* processor - psu_cortexa53_0 */
+#define CONFIG_CPU_ARMV8
+#define CONFIG_CLOCKS
+#define CONFIG_REMAKE_ELF
+#define CONFIG_BOARD_EARLY_INIT_F
+#define CONFIG_ARM_DCC
+#define CONFIG_MP
+
+/* main_memory - psu_ddr_0 */
+
+/* uart - psu_uart_1 */
+#define PSSERIAL0	"psserial0=setenv stdout ttyPS0;setenv stdin ttyPS0\0"
+#define SERIAL_MULTI	"serial=setenv stdout serial;setenv stdin serial\0"
+#define CONSOLE_ARG	"console=console=ttyPS0,115200\0"
+#define SERIAL_MULTI  "serial=setenv stdout serial;setenv stdin serial\0"
+#define CONFIG_BAUDRATE	115200
+
+/* sdio - psu_sd_1 */
+#define CONFIG_SUPPORT_EMMC_BOOT
+
+/* sdio - psu_sd_0 */
+
+/* rtc - psu_rtc */
+
+/* i2c - psu_i2c_1 */
+
+/* usb - psu_usb_1 */
+#define CONFIG_THOR_RESET_OFF
+#define CONFIG_SYS_DFU_DATA_BUF_SIZE 0x1800000
+#define DFU_DEFAULT_POLL_TIMEOUT 300
+
+/* usb - psu_usb_0 */
+
+/* zynq_ultra_ps_e_0 */
+#define COUNTER_FREQUENCY 100000000
+
+/* intc - psu_acpu_gic */
+#define ACPU_GIC_BASEADDR	0xF9010000
+#define CONFIG_GICV2	1
+#define GICD_BASE	(ACPU_GIC_BASEADDR)
+#define GICC_BASE (ACPU_GIC_BASEADDR + 0x10000)
+
+/* FPGA */
+
+/* Memory testing handling */
+#define CONFIG_SYS_MEMTEST_START	0x0
+#define CONFIG_SYS_MEMTEST_END	(0x0 + 0x1000)
+#define CONFIG_SYS_LOAD_ADDR	(0x0 + 0x100000) /* default load address */
+#define CONFIG_SYS_INIT_SP_ADDR	(CONFIG_SYS_LOAD_ADDR - GENERATED_GBL_DATA_SIZE)
+#define CONFIG_NR_DRAM_BANKS	2
+
+/* Size of malloc() pool */
+#define SIZE	0x2000000
+#define CONFIG_SYS_MALLOC_LEN	SIZE
+
+#ifdef CONFIG_DM_SPI_FLASH
+# define CONFIG_SPI_GENERIC
+# define CONFIG_SF_DEFAULT_SPEED	30000000
+# define CONFIG_ENV_SPI_MAX_HZ		30000000
+# define CONFIG_SF_DUAL_FLASH
+# define CONFIG_CMD_SPI
+# define CONFIG_CMD_SF
+#endif
+
+
+
+/* BOOTP options */
+#define CONFIG_BOOTP_SERVERIP
+#define CONFIG_BOOTP_BOOTFILESIZE
+#define CONFIG_BOOTP_BOOTPATH
+#define CONFIG_BOOTP_GATEWAY
+#define CONFIG_BOOTP_HOSTNAME
+#define CONFIG_BOOTP_MAY_FAIL
+#define CONFIG_BOOTP_DNS
+#define CONFIG_BOOTP_SUBNETMASK
+#define CONFIG_BOOTP_PXE
+
+/*Command line configuration.*/
+#define CONFIG_CMDLINE_EDITING
+#define CONFIG_AUTO_COMPLETE
+
+#define CONFIG_IMAGE_FORMAT_LEGACY
+#define CONFIG_SUPPORT_RAW_INITRD
+
+/* Miscellaneous configurable options */
+#define CONFIG_SYS_CBSIZE	2048/* Console I/O Buffer Size      */
+#define CONFIG_SYS_PBSIZE	(CONFIG_SYS_CBSIZE + sizeof(CONFIG_SYS_PROMPT) + 16)
+#define CONFIG_SYS_BARGSIZE CONFIG_SYS_CBSIZE
+
+/* Use the HUSH parser */
+#define CONFIG_SYS_PROMPT_HUSH_PS2 "> "
+
+#define CONFIG_ENV_VARS_UBOOT_CONFIG
+#define CONFIG_ENV_OVERWRITE	/* Allow to overwrite the u-boot environment variables */
+
+#define CONFIG_LMB
+
+/* FDT support */
+#define CONFIG_DISPLAY_BOARDINFO_LATE
+
+
+/* Boot Argument Buffer Size */
+#define CONFIG_SYS_MAXARGS      64      /* max number of command args */
+#define CONFIG_SYS_LONGHELP
+
+/* Initial memory map for Linux */
+#define CONFIG_SYS_BOOTMAPSZ 0x8000000
+
+/* Environment settings*/
+#define CONFIG_ENV_SIZE	0x80000
+
+/* PREBOOT */
+#define CONFIG_PREBOOT	"echo U-BOOT for ultra96v1-holosynthv-petalinux;setenv preboot; echo; "
+
+/* Extra U-Boot Env settings */
+#define CONFIG_EXTRA_ENV_SETTINGS \
+	SERIAL_MULTI \ 
+	CONSOLE_ARG \ 
+	DFU_ALT_INFO_RAM \ 
+	DFU_ALT_INFO_MMC \ 
+	PSSERIAL0 \ 
+	"bootenv=uEnv.txt\0" \ 
+	"importbootenv=echo \"Importing environment from SD ...\"; " \ 
+		"env import -t ${loadbootenv_addr} $filesize\0" \ 
+	"loadbootenv=load mmc $sdbootdev:$partid ${loadbootenv_addr} ${bootenv}\0" \ 
+	"sd_uEnvtxt_existence_test=test -e mmc $sdbootdev:$partid /uEnv.txt\0" \ 
+	"uenvboot=" \ 
+		"if run sd_uEnvtxt_existence_test; then " \ 
+			"run loadbootenv; " \ 
+			"echo Loaded environment from ${bootenv}; " \ 
+			"run importbootenv; " \ 
+			"fi; " \ 
+		"if test -n $uenvcmd; then " \ 
+			"echo Running uenvcmd ...; " \ 
+			"run uenvcmd; " \ 
+		"fi\0" \ 
+	"autoload=no\0" \ 
+	"sdbootdev=0\0" \ 
+	"clobstart=0x10000000\0" \ 
+	"netstart=0x10000000\0" \ 
+	"dtbnetstart=0x23fff000\0" \ 
+	"loadaddr=0x10000000\0" \ 
+	"boot_img=BOOT.BIN\0" \ 
+	"install_boot=mmcinfo && fatwrite mmc ${sdbootdev} ${clobstart} ${boot_img} ${filesize}\0" \ 
+	"install_bootenv=mmcinfo && fatwrite mmc ${sdbootdev} ${clobstart} ${bootenv_img} ${filesize}\0" \ 
+	"kernel_img=image.ub\0" \ 
+	"install_kernel=mmcinfo && fatwrite mmc ${sdbootdev} ${clobstart} ${kernel_img} ${filesize}\0" \ 
+	"cp_kernel2ram=mmcinfo && fatload mmc ${sdbootdev} ${netstart} ${kernel_img}\0" \ 
+	"dtb_img=system.dtb\0" \ 
+	"sd_update_dtb=echo Updating dtb from SD; mmcinfo && fatload mmc ${sdbootdev}:1 ${clobstart} ${dtb_img} && run install_dtb\0" \ 
+	"loadbootenv_addr=0x00100000\0" \ 
+	"fault=echo ${img} image size is greater than allocated place - partition ${img} is NOT UPDATED\0" \ 
+	"test_crc=if imi ${clobstart}; then run test_img; else echo ${img} Bad CRC - ${img} is NOT UPDATED; fi\0" \ 
+	"test_img=setenv var \"if test ${filesize} -gt ${psize}\\; then run fault\\; else run ${installcmd}\\; fi\"; run var; setenv var\0" \ 
+	"default_bootcmd=run uenvboot; run cp_kernel2ram && bootm ${netstart}\0" \ 
+""
+
+/* BOOTCOMMAND */
+#define CONFIG_BOOTCOMMAND	"run default_bootcmd"
+
+#endif /* __PLNX_CONFIG_H */
diff --git a/include/configs/platform-top.h b/include/configs/platform-top.h
new file mode 100755
index 0000000000..d0545d48df
--- /dev/null
+++ b/include/configs/platform-top.h
@@ -0,0 +1,38 @@
+#include <configs/platform-auto.h>
+#define CONFIG_SYS_BOOTM_LEN 0xF000000
+
+#define DFU_ALT_INFO_RAM \
+                "dfu_ram_info=" \
+        "setenv dfu_alt_info " \
+        "image.ub ram $netstart 0x1e00000\0" \
+        "dfu_ram=run dfu_ram_info && dfu 0 ram 0\0" \
+        "thor_ram=run dfu_ram_info && thordown 0 ram 0\0"
+
+#define DFU_ALT_INFO_MMC \
+        "dfu_mmc_info=" \
+        "set dfu_alt_info " \
+        "${kernel_image} fat 0 1\\\\;" \
+        "dfu_mmc=run dfu_mmc_info && dfu 0 mmc 0\0" \
+        "thor_mmc=run dfu_mmc_info && thordown 0 mmc 0\0"
+
+/*Required for uartless designs */
+#ifndef CONFIG_BAUDRATE
+#define CONFIG_BAUDRATE 115200
+#ifdef CONFIG_DEBUG_UART
+#undef CONFIG_DEBUG_UART
+#endif
+#endif
+
+#define CONFIG_CMD_DNS
+
+#define CONFIG_EXTRA_ENV_SETTINGS \
+"autoload=yes\0" \
+"hostname=holosynthv-u96\0" \
+"default_bootcmd=mmcinfo && fatload mmc 0 " \
+    "10000000 image.ub && bootm 10000000\0" \
+"4.19tftpboot=setenv bootargs console=ttyPS0,115200 " \
+    "root=/dev/mmcblk0p2 rw earlyprintk rootwait;" \
+    "usb start && dhcp 8000000 design_1_wrapper.bit && " \
+    "fpga load 0 8000000 $filesize && mmcinfo && " \
+    "load mmc 0 10000000 Image && load mmc 0 16000000" \
+    " avnet-ultra96-rev1.dtb && booti 10000000 - 16000000\0"
-- 
2.25.1


From 585a497b48ebfca1b03b37f739495cae10730693 Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Wed, 22 Apr 2020 02:36:18 +0200
Subject: [PATCH 3/3] Enable send hostname to dhcp server add some u-boot
 variables

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 include/configs/platform-top.h | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/include/configs/platform-top.h b/include/configs/platform-top.h
index d0545d48df..dd5cd2fcec 100755
--- a/include/configs/platform-top.h
+++ b/include/configs/platform-top.h
@@ -24,6 +24,7 @@
 #endif
 
 #define CONFIG_CMD_DNS
+#define CONFIG_BOOTP_SEND_HOSTNAME
 
 #define CONFIG_EXTRA_ENV_SETTINGS \
 "autoload=yes\0" \
@@ -31,8 +32,16 @@
 "default_bootcmd=mmcinfo && fatload mmc 0 " \
     "10000000 image.ub && bootm 10000000\0" \
 "4.19tftpboot=setenv bootargs console=ttyPS0,115200 " \
-    "root=/dev/mmcblk0p2 rw earlyprintk rootwait;" \
-    "usb start && dhcp 8000000 design_1_wrapper.bit && " \
+    "root=/dev/mmcblk0p2 rw earlyprintk " \
+    "clk_ignore_unused cpuidle.off=1 rootwait;" \
+    "usb start && dhcp 8000000 holosynthv_wrapper.bit && " \
     "fpga load 0 8000000 $filesize && mmcinfo && " \
     "load mmc 0 10000000 Image && load mmc 0 16000000" \
-    " avnet-ultra96-rev1.dtb && booti 10000000 - 16000000\0"
+    " avnet-ultra96-rev1.dtb && booti 10000000 - 16000000\0" \
+"4.19tftpbootu=setenv bootargs console=ttyPS0,115200 " \
+    "root=/dev/mmcblk0p2 rw earlyprintk clk_ignore_unused " \
+    "cpuclk_ignore_unused cpuidle.off=1 rootwait;" \
+    "usb start && run set_serverip && dhcp 8000000 " \
+    "holosynthv_wrapper.bit && fpga load 0 8000000 " \
+    "$filesize && mmcinfo && fatload mmc 0 10000000 " \
+    "image.ub && bootm 10000000\0"
-- 
2.25.1

